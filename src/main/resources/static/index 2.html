<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swym Nation System Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f8; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { background: #ffffff; min-height: 100vh; border-right: 1px solid #dee2e6; }
        .nav-pills .nav-link.active { background-color: #0d6efd; box-shadow: 0 4px 6px rgba(13,110,253,0.3); }
        .nav-pills .nav-link { color: #495057; font-weight: 500; margin-bottom: 5px; border-radius: 8px; }
        .nav-pills .nav-link:hover { background-color: #e9ecef; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 12px; }
        .debug-console { background: #212529; color: #00ff00; font-family: monospace; padding: 15px; border-radius: 8px; height: 200px; overflow-y: auto; font-size: 0.85rem; }
        .status-badge { font-size: 0.8em; padding: 5px 10px; border-radius: 20px; }
        .table-responsive { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar p-4">
            <h5 class="text-primary fw-bold mb-4">üèä Swym Nation<br><span class="text-muted small">Verification Dashboard</span></h5>
            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-fr01" type="button">FR-01: Registration</button>
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-fr02" type="button">FR-02: Attendance</button>
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-fr03" type="button">FR-03: Payments</button>
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-fr04" type="button">FR-04: Progress</button>
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-fr05" type="button">FR-05: Reports</button>
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-fr06" type="button">FR-06: Notifications</button>
            </div>
        </div>

        <div class="col-md-10 p-4">
            <div class="tab-content" id="v-pills-tabContent">

                <div class="tab-pane fade show active" id="tab-fr01">
                    <div class="card p-4 mb-4">
                        <h4 class="mb-3">FR-01: Digital Registration</h4>
                        <div class="row">
                            <div class="col-md-5">
                                <form id="regForm" novalidate>
                                    <div class="mb-2">
                                        <label>First Name <span class="text-danger">*</span></label>
                                        <input type="text" id="r-fname" class="form-control" value="Alice" required>
                                        <div class="invalid-feedback">First name is required.</div>
                                    </div>
                                    <div class="mb-2">
                                        <label>Last Name <span class="text-danger">*</span></label>
                                        <input type="text" id="r-lname" class="form-control" value="Smith" required>
                                        <div class="invalid-feedback">Last name is required.</div>
                                    </div>
                                    <div class="mb-2">
                                        <label>Email <span class="text-danger">*</span></label>
                                        <input type="email" id="r-email" class="form-control" value="alice@test.com" required>
                                        <div class="invalid-feedback">Please enter a valid email.</div>
                                    </div>
                                    <div class="mb-2">
                                        <label>Phone <span class="text-danger">*</span></label>
                                        <input type="text" id="r-phone" class="form-control" value="876-555-0101" pattern="^[\d\+\-\s]+$" required>
                                        <div class="invalid-feedback">Invalid phone format.</div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Address <span class="text-danger">*</span></label>
                                        <input type="text" id="r-addr" class="form-control" value="123 Kingston Blvd" required>
                                        <div class="invalid-feedback">Address is required.</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">Register New Client</button>
                                </form>
                            </div>
                            <div class="col-md-7">
                                <h6>Registered Clients Database (Simulated View)</h6>
                                <div class="table-responsive bg-white border rounded">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Email</th><th>Status</th></tr></thead>
                                        <tbody id="clientTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-fr02">
                    <div class="card p-4 mb-4">
                        <h4 class="mb-3">FR-02: Attendance Management</h4>
                        <div class="row align-items-end">
                            <div class="col-md-4">
                                <label>Select Student</label>
                                <select id="att-student" class="form-select"></select>
                            </div>
                            <div class="col-md-3">
                                <label>Status</label>
                                <select id="att-status" class="form-select">
                                    <option value="PRESENT">Present</option>
                                    <option value="ABSENT">Absent</option>
                                    <option value="LATE">Late</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-warning w-100 text-white" onclick="handleAttendance()">Mark Status</button>
                            </div>
                        </div>
                        <hr>
                        <h6>Class Roster Status</h6>
                        <ul class="list-group" id="attendanceList"></ul>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-fr03">
                    <div class="card p-4 mb-4">
                        <h4 class="mb-3">FR-03: Payments & Receipts</h4>
                        <div class="row">
                            <div class="col-md-6 border-end">
                                <label>Select Client to Pay</label>
                                <select id="pay-student" class="form-select mb-3"></select>
                                <label>Amount (JMD)</label>
                                <input type="number" id="pay-amt" class="form-control mb-3" value="15000">
                                <button class="btn btn-success w-100" onclick="handlePayment()">Simulate Payment</button>
                            </div>
                            <div class="col-md-6 d-flex justify-content-center align-items-center">
                                <div id="receipt-card" class="card bg-light border-0 p-3 d-none" style="width: 100%; border-left: 5px solid #198754 !important;">
                                    <h5 class="text-success"><i class="bi bi-receipt"></i> Payment Successful</h5>
                                    <p class="mb-1" id="receipt-text" style="font-family: monospace;"></p>
                                    <small class="text-muted">Digital Receipt Generated <span id="receipt-time"></span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-fr04">
                    <div class="card p-4 mb-4">
                        <h4 class="mb-3">FR-04: Student Progress Tracking</h4>
                        <div class="row">
                            <div class="col-md-5">
                                <label>Student</label>
                                <select id="prog-student" class="form-select mb-2"></select>
                                <label>New Skill Level (1-8)</label>
                                <input type="number" id="prog-level" class="form-control mb-2" min="1" max="8" value="1">
                                <label>Progress Notes</label>
                                <textarea id="prog-notes" class="form-control mb-3" rows="3" placeholder="Enter notes... (Max 500 chars)"></textarea>
                                <button class="btn btn-info text-white w-100" onclick="handleProgress()">Update History</button>
                            </div>
                            <div class="col-md-7">
                                <h6>Student History Log</h6>
                                <div id="progress-history" class="list-group"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-fr05">
                    <div class="card p-4 mb-4">
                        <h4 class="mb-3">FR-05: Reporting Dashboard</h4>
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-outline-primary" onclick="handleReport('FINANCIAL')">Generate Financial Report</button>
                            <button class="btn btn-outline-dark" onclick="handleReport('ATTENDANCE')">Generate Attendance Summary</button>
                        </div>
                        <div class="bg-light p-3 rounded border">
                            <h6>Report Output Preview</h6>
                            <pre id="report-output" class="mb-0 text-muted">No report generated yet.</pre>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-fr06">
                    <div class="card p-4 mb-4">
                        <h4 class="mb-3">FR-06: Notification System</h4>
                        <div class="input-group mb-3">
                            <span class="input-group-text">Subject</span>
                            <input type="text" id="notif-subj" class="form-control" value="Class Cancellation">
                            <button class="btn btn-danger" onclick="handleNotification()">Trigger Alert</button>
                        </div>
                        <input type="text" id="notif-body" class="form-control mb-3" value="Due to weather, class is cancelled.">
                        
                        <h6>System Notification Log (Inbox)</h6>
                        <ul class="list-group" id="notif-list"></ul>
                    </div>
                </div>

            </div>

            <div class="mt-4">
                <h6>Backend Communication Log (Raw JSON Verification)</h6>
                <div id="debug-log" class="debug-console">Waiting for interaction...</div>
                <div class="text-end mt-1"><button class="btn btn-sm btn-link text-secondary" onclick="document.getElementById('debug-log').innerHTML=''">Clear Log</button></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- STATE MANAGEMENT ---
    const state = { clients: [] };

    // --- HELPER: API CALL & LOGGER ---
    async function apiCall(url, method, body, headers = {}) {
        const log = document.getElementById('debug-log');
        const timestamp = new Date().toISOString().split('T')[1].slice(0,8);
        
        log.innerHTML += `<div><span class="text-secondary">[${timestamp}]</span> <span class="text-warning">${method}</span> ${url}</div>`;
        if(body) log.innerHTML += `<div class="text-muted ms-3">Payload: ${JSON.stringify(body)}</div>`;

        try {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json', ...headers }
            };
            if(body && method !== 'GET') options.body = JSON.stringify(body);

            const res = await fetch(url, options);
            const text = await res.text();
            
            let display = text;
            try { display = JSON.stringify(JSON.parse(text), null, 2); } catch(e){}

            const color = res.ok ? 'text-success' : 'text-danger';
            log.innerHTML += `<div class="${color} ms-3">Response (${res.status}): ${display}</div><br>`;
            log.scrollTop = log.scrollHeight;
            
            if (!res.ok) throw new Error(text);
            return text;
        } catch (err) {
            log.innerHTML += `<div class="text-danger ms-3">ERROR: ${err.message}</div><br>`;
            throw err;
        }
    }

    // --- FR-01 REGISTRATION (UPDATED WITH VALIDATION LOGIC) ---
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById('regForm');
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            // 1. Frontend Validation Check [FR-01 SR 2]
            if (form.checkValidity()) {
                handleRegister(); 
            } else {
                // Trigger Bootstrap validation UI
                form.classList.add('was-validated'); 
            }
        }, false);
    });

    async function handleRegister() {
        const data = {
            firstName: document.getElementById('r-fname').value,
            lastName: document.getElementById('r-lname').value,
            email: document.getElementById('r-email').value,
            phoneNumber: document.getElementById('r-phone').value,
            address: document.getElementById('r-addr').value
        };

        try {
            const resText = await apiCall('/api/clients/register', 'POST', data);
            
            const idMatch = resText.match(/ID (\d+)/);
            const newId = idMatch ? idMatch[1] : "NEW";

            const clientObj = { id: newId, name: `${data.firstName} ${data.lastName}`, email: data.email };
            state.clients.push(clientObj);
            updateClientDropdowns();
            
            const row = `<tr><td>${clientObj.id}</td><td>${clientObj.name}</td><td>${clientObj.email}</td><td><span class="badge bg-success">Active</span></td></tr>`;
            document.getElementById('clientTableBody').insertAdjacentHTML('beforeend', row);
            
            // Clear form and validation styles on success
            const form = document.getElementById('regForm');
            form.reset();
            form.classList.remove('was-validated');
            alert("Registration Successful!");

        } catch (e) { 
            // 4. Display Clear Error Messages [FR-01 AC 2]
            alert("Registration Failed: " + e.message); 
        }
    }

    function updateClientDropdowns() {
        const options = state.clients.map(c => `<option value="${c.id}">${c.name} (ID: ${c.id})</option>`).join('');
        document.getElementById('att-student').innerHTML = options;
        document.getElementById('pay-student').innerHTML = options;
        document.getElementById('prog-student').innerHTML = options;
    }

    // --- FR-02 ATTENDANCE ---
    async function handleAttendance() {
        const studentId = document.getElementById('att-student').value;
        const status = document.getElementById('att-status').value;
        const name = document.getElementById('att-student').options[document.getElementById('att-student').selectedIndex].text;

        if(!studentId) return alert("Register a client first!");

        const payload = [{
            studentId: studentId,
            status: status,
            attendanceDate: new Date().toISOString()
        }];

        try {
            await apiCall('/api/attendance/mark', 'POST', payload, { 'X-Role': 'INSTRUCTOR' });
            
            const badgeClass = status === 'PRESENT' ? 'bg-success' : (status === 'ABSENT' ? 'bg-danger' : 'bg-warning');
            const item = `<li class="list-group-item d-flex justify-content-between align-items-center">
                ${name}
                <span class="badge ${badgeClass} rounded-pill">${status}</span>
            </li>`;
            document.getElementById('attendanceList').insertAdjacentHTML('afterbegin', item);
        } catch (e) {}
    }

    // --- FR-03 PAYMENTS ---
    async function handlePayment() {
        const id = document.getElementById('pay-student').value;
        const amt = document.getElementById('pay-amt').value;
        if(!id) return alert("Select a client!");

        try {
            const res = await apiCall(`/api/payments/process?clientId=${id}&amount=${amt}`, 'POST', null);
            document.getElementById('receipt-card').classList.remove('d-none');
            document.getElementById('receipt-text').innerText = res;
            document.getElementById('receipt-time').innerText = new Date().toLocaleTimeString();
        } catch (e) {}
    }

    // --- FR-04 PROGRESS ---
    async function handleProgress() {
        const id = document.getElementById('prog-student').value;
        const level = document.getElementById('prog-level').value;
        const notes = document.getElementById('prog-notes').value;
        const name = document.getElementById('prog-student').options[document.getElementById('prog-student').selectedIndex].text;

        if(!id) return alert("Select a client!");

        try {
            await apiCall(`/api/progress/update?studentId=${id}&level=${level}&notes=${encodeURIComponent(notes)}`, 'POST', null, { 'X-Role': 'INSTRUCTOR' });
            
            const item = `<a href="#" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">${name}</h5>
                    <small>${new Date().toLocaleDateString()}</small>
                </div>
                <p class="mb-1">Updated to <strong>Level ${level}</strong></p>
                <small class="text-muted">"${notes}" - Instructor ID: 55</small>
            </a>`;
            document.getElementById('progress-history').insertAdjacentHTML('afterbegin', item);
        } catch (e) {}
    }

    // --- FR-05 REPORTS ---
    async function handleReport(type) {
        try {
            const res = await apiCall(`/api/reports/generate?type=${type}`, 'GET', null, { 'X-Role': 'ADMINISTRATOR' });
            document.getElementById('report-output').innerText = res;
        } catch (e) {}
    }

    // --- FR-06 NOTIFICATIONS ---
    async function handleNotification() {
        const subj = document.getElementById('notif-subj').value;
        const body = document.getElementById('notif-body').value;

        try {
            await apiCall(`/api/notifications/trigger?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`, 'POST', null, { 'X-Role': 'ADMINISTRATOR' });
            
            const item = `<li class="list-group-item">
                <i class="bi bi-bell-fill text-primary"></i> 
                <strong>${subj}</strong>: ${body}
                <span class="float-end text-muted small">Just now</span>
            </li>`;
            document.getElementById('notif-list').insertAdjacentHTML('afterbegin', item);
        } catch (e) {}
    }
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</body>
</html>